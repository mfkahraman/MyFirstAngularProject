
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold mb-0"><i class="bi bi-journal-text me-2"></i>Blogs</h2>
  <div class="input-group w-auto">
    <input type="text" class="form-control" placeholder="Search blogs..." [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange($event)">
    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
  </div>
</div>

@if (isLoading) {
  <div class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
} @else {
<div class="card shadow-sm border-0">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Blog Title</th>
            <th>Writer</th>
            <th>Category</th>
            <th>Tags</th>
            <th>Content</th>
            <th>Created At</th>
            <th>Blog Cover</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
  <tbody>
    @for (item of blogList | blogSearch: searchTerm | paginate: { itemsPerPage: 5, currentPage: page }; track item.id; let i = $index) {
      <tr>
        <td class="fw-bold text-muted">{{ i + 1 }}</td>
        <td class="fw-semibold">{{ item.title }}</td>
        <td>{{ item.writer?.fullName }}</td>
        <td><span class="badge bg-light text-dark border">{{ item.category?.name }}</span></td>
        <td>
          @if (item.blogTags && item.blogTags.length > 0) {
            @for (blogTag of item.blogTags; track blogTag.id) {
                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary me-1">{{ getTagName(blogTag.tagId) }}</span>
            }
          } @else {
            <span class="text-muted">No tags</span>
          }
        </td>
        <td>{{ item.content.length > 100 ? (item.content.substring(0, 100) + '...') : item.content }}</td>
        <td><span class="text-secondary small">{{ item.createdAt | date:'short' }}</span></td>
        <td><img [src]="getImageUrl(item.coverImageUrl)" [alt]="'Cover image for ' + item.title" class="blog-cover-thumbnail shadow-sm" (error)="onImageError($event)" /></td>
        <td class="text-center">
          <button class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#editModal"
            (click)="onSelected(item)"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-outline-danger btn-sm" (click)="deleteBlog(item.id)"><i class="bi bi-trash"></i></button>
        </td>
      </tr>
    }
  </tbody>

      </table>
    </div>
  </div>
</div>

<!-- Pagination Controls -->
<div class="d-flex justify-content-center mt-3">
  <pagination-controls (pageChange)="page = $event" previousLabel="Previous" nextLabel="Next">
  </pagination-controls>
</div>

<div class="d-flex justify-content-end mt-4">
  <button class="btn btn-success shadow-sm" data-bs-toggle="modal" data-bs-target="#createModal">
    <i class="bi bi-plus-circle me-1"></i> Add New Blog
  </button>
</div>
}


<!--Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <form #createForm="ngForm" (ngSubmit)="createBlog(); createForm.resetForm()">
      <div class="modal-content shadow-lg border-0 rounded-4">
        <div class="modal-header bg-primary bg-opacity-10 border-0 rounded-top-4">
          <h1 class="modal-title fs-5 fw-bold text-primary" id="createModalLabel"><i class="bi bi-plus-circle me-2"></i>Add New Blog</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" for="title">Blog Title</label>
            <input type="text" class="form-control" id="title" [(ngModel)]="blog.title" name="title"
              placeholder="Enter the blog title" required="" />
          </div>
          <div class="form-group">
            <label class="form-label" for="writerId">Writer</label>
            <select class="form-control" id="writerId" [(ngModel)]="blog.writerId" name="writerId" required="">
              <option [value]="undefined" disabled>Select Writer</option>
              @for (writer of writerList; track writer.id) {
                <option [value]="writer.id">
                  {{ writer.fullName }}
                </option>
              }
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="categoryId">Category</label>
            <select class="form-control" id="categoryId" [(ngModel)]="blog.categoryId" name="categoryId" required="">
              <option [value]="undefined" disabled>Select Category</option>
              @for (category of categoryList; track category.id) {
                <option [value]="category.id">
                  {{ category.name }}
                </option>
              }
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="tags">Tags</label>
            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
              @if (tagList.length === 0) {
                <p class="text-muted">No tags available</p>
              } @else {
                @for (tag of tagList; track tag.id) {
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [id]="'tag-' + tag.id"
                      [checked]="isTagSelected(tag.id)"
                      (change)="toggleTag(tag.id)"
                    />
                    <label class="form-check-label" [for]="'tag-' + tag.id">
                      {{ tag.name }}
                    </label>
                  </div>
                }
              }
            </div>
            <small class="form-text text-muted">Select one or more tags</small>
          </div>
          <div class="form-group">
            <label class="form-label" for="content">Content <span class="text-danger">*</span></label>
            <textarea class="form-control" id="content" [(ngModel)]="blog.content" name="content"
              placeholder="Enter the blog content" rows="5" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="coverImageUrl">Cover Image</label>
            <input type="file" class="form-control" id="coverImageUrl" (change)="onCoverFileSelected($event)"
              accept="image/*" name="coverImageUrl" required="" />
            <small class="form-text text-muted">Supported formats: JPG, PNG, GIF</small>
            @if (coverImagePreview) {
            <div class="mt-3 text-center">
              <img [src]="coverImagePreview" alt="Cover image preview" class="image-preview">
            </div>
            }
          </div>
          <div class="form-group">
            <label class="form-label" for="contentImageUrl">Content Image</label>
            <input type="file" class="form-control" id="contentImageUrl" (change)="onContentFileSelected($event)"
              accept="image/*" name="contentImageUrl" required="" />
            <small class="form-text text-muted">Supported formats: JPG, PNG, GIF</small>
            @if (contentImagePreview) {
            <div class="mt-3 text-center">
              <img [src]="contentImagePreview" alt="Content image preview" class="image-preview">
            </div>
            }
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary shadow-sm" data-bs-dismiss="modal"
            [disabled]="createForm.invalid || !createForm.dirty">
            <i class="bi bi-save me-1"></i>Save
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!--Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <form #editForm="ngForm" (ngSubmit)="updateBlog()">
      <div class="modal-content shadow-lg border-0 rounded-4">
        <div class="modal-header bg-warning bg-opacity-10 border-0 rounded-top-4">
          <h1 class="modal-title fs-5 fw-bold text-warning" id="editModalLabel"><i class="bi bi-pencil-square me-2"></i>Edit Blog</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" for="editTitle">Blog Title</label>
            <input type="text" class="form-control" id="editTitle" [(ngModel)]="editBlog.title" name="editTitle"
              placeholder="Enter the blog title" required="" />
          </div>
          <div class="form-group">
            <label class="form-label" for="editWriterId">Writer</label>
            <select class="form-control" id="editWriterId" [(ngModel)]="editBlog.writerId" name="editWriterId" required="">
              <option [value]="undefined" disabled>Select Writer</option>
              @for (writer of writerList; track writer.id) {
                <option [value]="writer.id">
                  {{ writer.fullName }}
                </option>
              }
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="editCategoryId">Category</label>
            <select class="form-control" id="editCategoryId" [(ngModel)]="editBlog.categoryId" name="editCategoryId" required="">
              <option [value]="undefined" disabled>Select Category</option>
              @for (category of categoryList; track category.id) {
                <option [value]="category.id">
                  {{ category.name }}
                </option>
              }
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="editTags">Tags</label>
            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
              @if (tagList.length === 0) {
                <p class="text-muted">No tags available</p>
              } @else {
                @for (tag of tagList; track tag.id) {
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [id]="'edit-tag-' + tag.id"
                      [checked]="isEditTagSelected(tag.id)"
                      (change)="toggleEditTag(tag.id)"
                    />
                    <label class="form-check-label" [for]="'edit-tag-' + tag.id">
                      {{ tag.name }}
                    </label>
                  </div>
                }
              }
            </div>
            <small class="form-text text-muted">Select one or more tags</small>
          </div>
          <div class="form-group">
            <label class="form-label" for="editContent">Content <span class="text-danger">*</span></label>
            <textarea class="form-control" id="editContent" [(ngModel)]="editBlog.content" name="editContent"
              placeholder="Enter the blog content" rows="5" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label" for="editCoverImageUrl">Cover Image</label>
            <input type="file" class="form-control" id="editCoverImageUrl" (change)="onEditCoverFileSelected($event)"
              accept="image/*" name="editCoverImageUrl" />
            <small class="form-text text-muted">Leave empty to keep current image</small>
            @if (editCoverImagePreview) {
            <div class="mt-3 text-center">
              <img [src]="editCoverImagePreview" alt="Cover image preview" class="image-preview">
            </div>
            } @else if (editBlog.coverImageUrl) {
            <div class="mt-3 text-center">
              <img [src]="getImageUrl(editBlog.coverImageUrl)" alt="Current cover image" class="image-preview">
            </div>
            }
          </div>
          <div class="form-group">
            <label class="form-label" for="editContentImageUrl">Content Image</label>
            <input type="file" class="form-control" id="editContentImageUrl" (change)="onEditContentFileSelected($event)"
              accept="image/*" name="editContentImageUrl" />
            <small class="form-text text-muted">Leave empty to keep current image</small>
            @if (editContentImagePreview) {
            <div class="mt-3 text-center">
              <img [src]="editContentImagePreview" alt="Content image preview" class="image-preview">
            </div>
            } @else if (editBlog.contentImageUrl) {
            <div class="mt-3 text-center">
              <img [src]="getImageUrl(editBlog.contentImageUrl)" alt="Current content image" class="image-preview">
            </div>
            }
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning shadow-sm" data-bs-dismiss="modal"
            [disabled]="editForm.invalid || !editForm.dirty">
            <i class="bi bi-save me-1"></i>Update
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
