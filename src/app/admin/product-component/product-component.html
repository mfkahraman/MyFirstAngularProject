<div class="product-header">
  <div class="header-content">
    <h2 class="page-title">
      <i class="bi bi-box-seam"></i>
      Products
    </h2>
    <p class="page-subtitle">Manage your product inventory</p>
  </div>
  <button class="btn btn-primary add-btn" data-bs-toggle="modal" data-bs-target="#createModal">
    <i class="bi bi-plus-circle"></i>
    Add New Product
  </button>
</div>

<div class="search-filter-section">
  <div class="search-box">
    <i class="bi bi-search search-icon"></i>
    <input type="text" class="form-control" placeholder="Search products..." [(ngModel)]="searchText" (input)="filterProducts()">
  </div>
  <div class="filter-box">
    <i class="bi bi-funnel filter-icon"></i>
    <select class="form-select" [(ngModel)]="selectedCategoryId" (change)="filterProducts()">
      <option [value]="null">All Categories</option>
      <option *ngFor="let category of categoryList" [value]="category.id">
        {{ category.categoryName }}
      </option>
    </select>
  </div>
</div>

<div class="products-grid">
  @for (item of filteredProductList | paginate: { itemsPerPage: itemsPerPage, currentPage: page }; track item.id; let i = $index) {
  <div class="product-card">
    <div class="product-image-container">
      <img [src]="(item.thumbnailImagePath || item.imagePath)" [alt]="item.productName" class="product-image" (error)="onImageError($event)">
      <div class="product-overlay">
        <button class="btn btn-light btn-sm" (click)="onSelected(item)" data-bs-toggle="modal"
          data-bs-target="#editModal" title="Edit">
          <i class="bi bi-pencil-square"></i>
        </button>
        <button class="btn btn-danger btn-sm" (click)="deleteProduct(item.id)" title="Delete">
          <i class="bi bi-trash3"></i>
        </button>
      </div>
    </div>
    <div class="product-body">
      <span class="product-category">
        <i class="bi bi-tag"></i>
        {{ item.category?.categoryName }}
      </span>
      <h5 class="product-name">{{ item.productName }}</h5>
      <p class="product-description">{{ item.shortDescription || item.description }}</p>
      @if (item.clientName) {
      <p class="product-client">
        <i class="bi bi-person-badge"></i>
        <strong>Client:</strong> {{ item.clientName }}
      </p>
      }
    </div>
  </div>
  }
  @empty {
  <div class="no-data">
    <i class="bi bi-inbox"></i>
    <p>No products found</p>
    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#createModal">
      <i class="bi bi-plus-circle"></i>
      Add Your First Product
    </button>
  </div>
  }
</div>

<!-- Pagination Controls -->
@if (filteredProductList.length > 0) {
<div class="pagination-wrapper">
  <pagination-controls (pageChange)="page = $event" previousLabel="Previous" nextLabel="Next">
  </pagination-controls>
</div>
}


<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <form #createForm="ngForm" (ngSubmit)="createProduct()">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="createModalLabel">
            <i class="bi bi-plus-circle"></i>
            Add New Product
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label" for="productName">
                  <i class="bi bi-box"></i>
                  Product Name
                </label>
                <input type="text" class="form-control" id="productName" [(ngModel)]="product.productName"
                  name="productName" placeholder="Enter product name" required />
                @if (errors && (errors.ProductName || errors.productName || errors.productDto)) {
                <div class="invalid-feedback d-block">
                  @for (error of (errors.ProductName || errors.productName || errors.productDto); track $index) {
                  <span>{{ error }}</span>
                  }
                </div>
                }
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label" for="categoryId">
                  <i class="bi bi-tags"></i>
                  Category
                </label>
                <select class="form-select" id="categoryId" [(ngModel)]="product.categoryId" name="categoryId" required>
                  <option [value]="undefined" disabled selected>Select a category</option>
                  <option *ngFor="let category of categoryList" [value]="category.id">
                    {{ category.categoryName }}
                  </option>
                </select>
                @if (errors && (errors.CategoryId || errors.categoryId || errors['$.categoryId'])) {
                <div class="invalid-feedback d-block">
                  @for (error of (errors.CategoryId || errors.categoryId || errors['$.categoryId']); track $index) {
                  <span>{{ error }}</span>
                  }
                </div>
                }
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="shortDescription">
              <i class="bi bi-card-text"></i>
              Short Description
            </label>
            <input type="text" class="form-control" id="shortDescription" [(ngModel)]="product.shortDescription"
              name="shortDescription" placeholder="Enter short description" />
            @if (errors && (errors.ShortDescription || errors.shortDescription)) {
            <div class="invalid-feedback d-block">
              @for (error of (errors.ShortDescription || errors.shortDescription); track $index) {
              <span>{{ error }}</span>
              }
            </div>
            }
          </div>
          <div class="form-group">
            <label class="form-label" for="description">
              <i class="bi bi-text-paragraph"></i>
              Full Description
            </label>
            <textarea class="form-control" id="description" rows="3" [(ngModel)]="product.description"
              name="description" placeholder="Enter detailed product description" required></textarea>
            @if (errors && (errors.Description || errors.description)) {
            <div class="invalid-feedback d-block">
              @for (error of (errors.Description || errors.description); track $index) {
              <span>{{ error }}</span>
              }
            </div>
            }
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label" for="clientName">
                  <i class="bi bi-person-badge"></i>
                  Client Name
                </label>
                <input type="text" class="form-control" id="clientName" [(ngModel)]="product.clientName"
                  name="clientName" placeholder="Enter client name" />
                @if (errors && (errors.ClientName || errors.clientName)) {
                <div class="invalid-feedback d-block">
                  @for (error of (errors.ClientName || errors.clientName); track $index) {
                  <span>{{ error }}</span>
                  }
                </div>
                }
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label" for="projectDate">
                  <i class="bi bi-calendar-event"></i>
                  Project Date
                </label>
                <input type="date" class="form-control" id="projectDate" [(ngModel)]="product.projectDate"
                  name="projectDate" />
                @if (errors && (errors.ProjectDate || errors.projectDate)) {
                <div class="invalid-feedback d-block">
                  @for (error of (errors.ProjectDate || errors.projectDate); track $index) {
                  <span>{{ error }}</span>
                  }
                </div>
                }
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="projectUrl">
              <i class="bi bi-link-45deg"></i>
              Project URL
            </label>
            <input type="url" class="form-control" id="projectUrl" [(ngModel)]="product.projectUrl"
              name="projectUrl" placeholder="https://example.com" />
            @if (errors && (errors.ProjectUrl || errors.projectUrl)) {
            <div class="invalid-feedback d-block">
              @for (error of (errors.ProjectUrl || errors.projectUrl); track $index) {
              <span>{{ error }}</span>
              }
            </div>
            }
          </div>
          <div class="form-group">
            <label class="form-label" for="imageFile">
              <i class="bi bi-image"></i>
              Hero Image (Main)
            </label>
            <input type="file" class="form-control" id="imageFile" (change)="onFileSelected($event)" accept="image/*"
              name="imageFile" required />
            <small class="form-text text-muted">Large image for product detail page (Max 5MB)</small>
            @if (imagePreview) {
            <div class="image-preview-container">
              <img [src]="imagePreview" alt="Preview" class="image-preview">
            </div>
            }
          </div>
          <div class="form-group">
            <label class="form-label" for="thumbnailFile">
              <i class="bi bi-image-fill"></i>
              Thumbnail Image
            </label>
            <input type="file" class="form-control" id="thumbnailFile" (change)="onThumbnailSelected($event)" accept="image/*"
              name="thumbnailFile" />
            <small class="form-text text-muted">Small preview image for product cards (Max 5MB)</small>
            @if (thumbnailPreview) {
            <div class="image-preview-container">
              <img [src]="thumbnailPreview" alt="Thumbnail Preview" class="image-preview">
            </div>
            }
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i>
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">
            <i class="bi bi-check-circle"></i>
            Save Product
          </button>
        </div>
      </div>
    </form>
  </div>
</div>


<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <form #editForm="ngForm" (ngSubmit)="updateProduct()">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="editModalLabel">
            <i class="bi bi-pencil-square"></i>
            Update Product
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label" for="editProductName">
                  <i class="bi bi-box"></i>
                  Product Name
                </label>
                <input type="text" class="form-control" id="editProductName" [(ngModel)]="editProduct.productName"
                  name="productName" placeholder="Enter product name" required />
                @if (errors && (errors.ProductName || errors.productName || errors.productDto)) {
                <div class="invalid-feedback d-block">
                  @for (error of (errors.ProductName || errors.productName || errors.productDto); track $index) {
                  <span>{{ error }}</span>
                  }
                </div>
                }
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label" for="editCategoryId">
                  <i class="bi bi-tags"></i>
                  Category
                </label>
                <select class="form-select" id="editCategoryId" [(ngModel)]="editProduct.categoryId" name="categoryId"
                  required>
                  <option *ngFor="let category of categoryList" [value]="category.id">
                    {{ category.categoryName }}
                  </option>
                </select>
                @if (errors && (errors.CategoryId || errors.categoryId || errors['$.categoryId'])) {
                <div class="invalid-feedback d-block">
                  @for (error of (errors.CategoryId || errors.categoryId || errors['$.categoryId']); track $index) {
                  <span>{{ error }}</span>
                  }
                </div>
                }
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="editShortDescription">
              <i class="bi bi-card-text"></i>
              Short Description
            </label>
            <input type="text" class="form-control" id="editShortDescription" [(ngModel)]="editProduct.shortDescription"
              name="shortDescription" placeholder="Enter short description" />
            @if (errors && (errors.ShortDescription || errors.shortDescription)) {
            <div class="invalid-feedback d-block">
              @for (error of (errors.ShortDescription || errors.shortDescription); track $index) {
              <span>{{ error }}</span>
              }
            </div>
            }
          </div>
          <div class="form-group">
            <label class="form-label" for="editDescription">
              <i class="bi bi-text-paragraph"></i>
              Full Description
            </label>
            <textarea class="form-control" id="editDescription" rows="3" [(ngModel)]="editProduct.description"
              name="description" placeholder="Enter detailed product description" required></textarea>
            @if (errors && (errors.Description || errors.description)) {
            <div class="invalid-feedback d-block">
              @for (error of (errors.Description || errors.description); track $index) {
              <span>{{ error }}</span>
              }
            </div>
            }
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label" for="editClientName">
                  <i class="bi bi-person-badge"></i>
                  Client Name
                </label>
                <input type="text" class="form-control" id="editClientName" [(ngModel)]="editProduct.clientName"
                  name="clientName" placeholder="Enter client name" />
                @if (errors && (errors.ClientName || errors.clientName)) {
                <div class="invalid-feedback d-block">
                  @for (error of (errors.ClientName || errors.clientName); track $index) {
                  <span>{{ error }}</span>
                  }
                </div>
                }
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label" for="editProjectDate">
                  <i class="bi bi-calendar-event"></i>
                  Project Date
                </label>
                <input type="date" class="form-control" id="editProjectDate" [(ngModel)]="editProduct.projectDate"
                  name="projectDate" />
                @if (errors && (errors.ProjectDate || errors.projectDate)) {
                <div class="invalid-feedback d-block">
                  @for (error of (errors.ProjectDate || errors.projectDate); track $index) {
                  <span>{{ error }}</span>
                  }
                </div>
                }
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="editProjectUrl">
              <i class="bi bi-link-45deg"></i>
              Project URL
            </label>
            <input type="url" class="form-control" id="editProjectUrl" [(ngModel)]="editProduct.projectUrl"
              name="projectUrl" placeholder="https://example.com" />
            @if (errors && (errors.ProjectUrl || errors.projectUrl)) {
            <div class="invalid-feedback d-block">
              @for (error of (errors.ProjectUrl || errors.projectUrl); track $index) {
              <span>{{ error }}</span>
              }
            </div>
            }
          </div>
          <div class="form-group">
            <label class="form-label" for="editImageFile">
              <i class="bi bi-image"></i>
              Hero Image (Main)
            </label>
            <input type="file" class="form-control" id="editImageFile" (change)="onEditFileSelected($event)"
              accept="image/*" name="editImageFile" />
            <small class="form-text text-muted">Leave empty to keep current hero image</small>
            @if (editImagePreview) {
            <div class="image-preview-container">
              <img [src]="editImagePreview" alt="Preview" class="image-preview">
            </div>
            } @else if (editProduct.imagePath) {
            <div class="image-preview-container">
              <img [src]="editProduct.imagePath" alt="Current Hero Image" class="image-preview">
            </div>
            }
          </div>
          <div class="form-group">
            <label class="form-label" for="editThumbnailFile">
              <i class="bi bi-image-fill"></i>
              Thumbnail Image
            </label>
            <input type="file" class="form-control" id="editThumbnailFile" (change)="onEditThumbnailSelected($event)"
              accept="image/*" name="editThumbnailFile" />
            <small class="form-text text-muted">Leave empty to keep current thumbnail</small>
            @if (editThumbnailPreview) {
            <div class="image-preview-container">
              <img [src]="editThumbnailPreview" alt="Thumbnail Preview" class="image-preview">
            </div>
            } @else if (editProduct.thumbnailImagePath) {
            <div class="image-preview-container">
              <img [src]="editProduct.thumbnailImagePath" alt="Current Thumbnail" class="image-preview">
            </div>
            }
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i>
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" data-bs-dismiss="modal" [disabled]="!editForm.dirty">
            <i class="bi bi-check-circle"></i>
            Update Product
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
